var g=class{static inject(e,t){t instanceof Function?this.__injectedMap.set(e,t):this.__instanceMap.set(e,t)}static getInject(e){let t=this.__instanceMap.get(e);if(t)return t;let i=this.__injectedMap.get(e);return i===void 0?null:(t=new i,this.__instanceMap.set(e,t),t)}};g.__injectedMap=new Map,g.__instanceMap=new Map;import{director as Ze,find as et,Node as tt}from"cc";import{AudioSource as Qe}from"cc";import{assetManager as Ve,SpriteFrame as Ke,Texture2D as $e}from"cc";import{assetManager as we}from"cc";var re=class{constructor(){this.__tickerList=[];this.__nextFrameCallBacks=[]}tick(e){let t;for(;this.__nextFrameCallBacks.length;)t=this.__nextFrameCallBacks.shift(),t.callBack.apply(t.caller);for(let i=0;i<this.__tickerList.length;i++)this.__tickerList[i].tick(e)}addTicker(e){if(this.__tickerList.indexOf(e)>=0)throw new Error("Ticker \u91CD\u590D\u6DFB\u52A0\uFF01");this.__tickerList.push(e)}removeTicker(e){let t=this.__tickerList.indexOf(e);if(t<0)throw new Error("\u627E\u4E0D\u5230\u8981\u5220\u9664\u7684Tick!");this.__tickerList.splice(t,1)}callNextFrame(e,t){for(let i=0;i<this.__nextFrameCallBacks.length;i++)if(this.__nextFrameCallBacks[i].equal(e,t))return;this.__nextFrameCallBacks.push(new Ae(e,t))}clearNextFrame(e,t){for(let i=0;i<this.__nextFrameCallBacks.length;i++)this.__nextFrameCallBacks[i].equal(e,t)&&this.__nextFrameCallBacks.splice(i,1)}},Ae=class{constructor(e,t){this.callBack=e,this.caller=t}equal(e,t){return!(this.caller!==t||this.callBack!==e)}};var c=class{static tick(e){this.impl.tick(e)}static addTicker(e){this.addTicker(e)}static removeTicker(e){this.removeTicker(e)}static callNextFrame(e,t){this.callNextFrame(e,t)}static clearNextFrame(e,t){this.clearNextFrame(e,t)}static get impl(){return this.__impl==null&&(this.__impl=g.getInject(this.KEY)),this.__impl==null&&(this.__impl=new re),this.__impl}};c.KEY="TickerManager";var se=class{constructor(e,t=1e3,i=0){this.__max=0;this.__class=e,this.__max=t,this.__using=new Set,this.__free=new Set;for(let r=0;r<i;r++)this.__free.add(new this.__class)}destroy(){this.releaseAll();for(let e of this.__free)e.destroy();return this.__free.clear(),this.__using.clear(),!0}acquire(){let e;if(this.__free.size>0)e=this.__free.values().next().value,this.__free.delete(e);else{if(this.size>=this.__max)throw new Error("\u5BF9\u8C61\u6C60\u5DF2\u6EE1");e=new this.__class}return this.__using.add(e),e}release(e){e.reset(),this.__using.delete(e),this.__free.add(e)}releaseAll(){this.__using.size!==0&&(this.__using.forEach(e=>{this.release(e)}),this.__using.clear())}get usingCount(){return this.__using.size}get freeCount(){return this.__free.size}get size(){return this.freeCount+this.usingCount}};var E=class{static acquire(e){let t=this.pools.get(e);return t?t.acquire():(this.pools.set(e,new se(e,1e3,0)),this.acquire(e))}static release(e,t){let i=this.pools.get(e);if(i)i.release(t);else throw new Error("\u5BF9\u8C61\u6C60\u4E0D\u5B58\u5728")}static releaseAll(e){let t=this.pools.get(e);if(t)t.releaseAll();else throw new Error("\u5BF9\u8C61\u6C60\u4E0D\u5B58\u5728")}static destroy(e){let t=this.pools.get(e);if(t)t.destroy(),this.pools.delete(e);else throw new Error("\u5BF9\u8C61\u6C60\u4E0D\u5B58\u5728")}static logStatus(){console.log("\u5404\u5BF9\u8C61\u6C60\u7684\u72B6\u6001\uFF1A"),this.pools.forEach((e,t)=>{console.log(`\u7C7B\u540D: ${t.name}`),console.log(`  \u5DF2\u4F7F\u7528\u5BF9\u8C61\u6570\u91CF: ${e.usingCount}`),console.log(`  \u7A7A\u95F2\u5BF9\u8C61\u6570\u91CF: ${e.freeCount}`)})}};E.pools=new Map;var b=class b{constructor(){this.progress=0;this.propagationStopped=!1}init(e,t,i,r,s=0){this.type=e,this.target=t,this.data=i,this.error=r,this.progress=s}reset(){this.type=void 0,this.target=void 0,this.data=null,this.error=void 0,this.progress=0}destroy(){return this.reset(),!0}release(){E.release(b,this)}static create(e,t,i,r,s){let n=E.acquire(b);return n.init(e,t,i,r,s),n}};b.START="START",b.PROGRESS="PROGRESS",b.COMPLETE="COMPLETE",b.ERROR="ERROR",b.SHOW="SHOW",b.HIDE="HIDE",b.ADD="ADD",b.REMOVE="REMOVE",b.UPDATE="UPDATE",b.CLEAR="CLEAR",b.STATE_CHANGED="STATE_CHANGED",b.VALUE_CHANGED="VALUE_CHANGED",b.ADD_CHILD="ADD_CHILD",b.REMOVE_CHILD="REMOVE_CHILD",b.CHILD_VALUE_CHANGED="CHILD_VALUE_CHANGED";var a=b;var ne=class{constructor(e,t,i,r=255){this.priority=255;this.type=e,this.caller=t,this.handler=i,this.priority=r}reset(){this.type=void 0,this.caller=void 0,this.handler=void 0,this.priority=255}destroy(){return this.reset(),!0}equal(e){return this.type===e.type&&this.caller===e.caller&&this.handler===e.handler}equals(e,t,i){return this.type===e&&this.handler===t&&this.caller===i}};var oe=class oe{constructor(e){this.eventAync=!1;this.__needEmit=[];this.__emitHelp=[];this.__target=e||this,this.__listeners=new Map,this.__callers=new Map}on(e,t,i,r){let s=this.__listeners.get(e);s||(s=[],this.__listeners.set(e,s));for(let l of s)if(l.equals(e,t,i))throw new Error(`\u91CD\u590D\u6DFB\u52A0\u4E8B\u4EF6\u76D1\u542C\uFF1A${e} ${t} ${i}`);let n=new ne(e,t,i,r);s.push(n),s.sort((l,h)=>l.priority-h.priority);let o=this.__callers.get(i);o||(o=[],this.__callers.set(i,o)),o.push(n)}off(e,t,i){let r=this.__listeners.get(e);if(!r)return;let s=r.findIndex(o=>o.equals(e,t,i));if(s<0)return;r.splice(s,1);let n=this.__callers.get(i);n&&(s=n.findIndex(o=>o.equals(e,t,i)),!(s<0)&&n.splice(s,1))}offByCaller(e){let t=this.__callers.get(e);if(t)for(;t.length>0;){let i=t[0];this.off(i.type,i.handler,i.caller)}}offAllEvent(){this.__listeners.forEach(e=>{e.forEach(t=>{t.destroy()})}),this.__listeners.clear(),this.__callers.clear()}emit(e,t,i,r){if(this.__listeners.has(e))return;let s=a.create(e,this.__target,t,i,r);this.__needEmit.push(s),this.eventAync?c.callNextFrame(this.__emit,this):this.__emit()}__emit(){this.__emitHelp.push(...this.__needEmit),this.__needEmit.splice(0,this.__needEmit.length);for(let e=0;e<this.__emitHelp.length;e++){let t=this.__emitHelp[e];if(this.hasEvent(t.type)&&t.propagationStopped==!1){let i=this.__listeners.get(t.type),r;for(let s=0;s<i.length&&(r=i[s],!t.propagationStopped);s++)r.handler.apply(r.caller,[t])}t.release()}this.__emitHelp.splice(0,this.__emitHelp.length)}hasEvent(e){return this.__listeners.has(e)}hasEventHandler(e,t,i){if(this.__listeners.has(e)==!1)return!1;let r=this.__listeners.get(e),s;for(let n=0;n<r.length;n++)if(s=r[n],s.equals(e,t,i))return!0;return!1}destroy(){return this.eventAync&&c.clearNextFrame(this.__emit,this),this.__needEmit.splice(0,this.__needEmit.length),this.__needEmit=void 0,this.__listeners.clear(),this.__listeners=void 0,this.__callers.clear(),this.__callers=void 0,this.__target=void 0,!0}};oe.Main=new oe;var f=oe;var M=class extends f{constructor(){super(),this.__map=new Map,this.__list=[]}set(e,t){let i;if(this.__map.has(e)){i=this.__map.get(e);let r=this.__list.indexOf(i);if(r<0)throw new Error("Dictionary\u5185\u90E8\u903B\u8F91\u9519\u8BEF\uFF01");this.__map.delete(e),this.__list.splice(r,1),this.emit(a.REMOVE,i)}this.__map.set(e,t),this.__list.push(t),this.emit(a.ADD,t)}has(e){return this.__map.has(e)}get(e){return this.__map.get(e)}getValue(e){if(e>=this.__list.length)throw new Error(e+"\u7D22\u5F15\u8D85\u51FA0-"+this.__list.length+"\u8303\u56F4");return this.__list[e]}delete(e){if(!this.__map.has(e))return;let t=this.__map.get(e),i=this.__list.indexOf(t);if(i<0)throw new Error("Dictionary\u5185\u90E8\u903B\u8F91\u9519\u8BEF\uFF01");return this.__list.splice(i,1),this.__map.delete(e),this.hasEvent(a.REMOVE)&&this.emit(a.REMOVE,t),t}clear(){this.__map.clear(),this.__list.length=0}getKeys(e){e=e||[];for(let t of this.__map.keys())e.push(t);return e}get elements(){return this.__list}get size(){return this.__map.size}destroy(){return super.destroy()?(this.__map.clear(),this.__map=void 0,this.__list=void 0,!0):!1}};import{game as Ne}from"cc";var ae=class{constructor(){this.__currentTime=0;this.__deltaTime=0;this.__startTime=0;this.reset(),c.addTicker(this)}reset(e){e?this.__currentTime=e:this.__currentTime=Ne.totalTime,this.__startTime=this.__currentTime}tick(e){this.__deltaTime=e,this.__currentTime+=e}get currentTime(){return this.__currentTime}get absTime(){return this.__startTime+Ne.totalTime}get deltaTime(){return this.__deltaTime}};var y=class{static get serverTime(){let e=this.currentTime-this.__lastTime;return e&&(this.__serverTime+=e),this.__serverTime}static get currentTime(){return this.impl.currentTime}static get absTime(){return this.impl.absTime}static reset(e){this.impl.reset(e)}static get impl(){return this.__impl==null&&(this.__impl=g.getInject(this.KEY)),this.__impl==null&&(this.__impl=new ae),this.__impl}};y.KEY="Timer",y.__serverTime=0,y.__lastTime=0;var le=class{constructor(){this.__resDic=new M;this._waitDestroy=[];this.__lastTime=0;c.addTicker(this)}tick(e){if(!v.AUTO_GC)return;let t=y.currentTime;t-this.__lastTime<v.GC_CHECK_TIME||(this.__lastTime=t,this.gc())}addRes(e){if(this.__resDic.has(e.key))throw new Error("\u91CD\u590D\u6DFB\u52A0\u8D44\u6E90\uFF01");this.__resDic.set(e.key,e),this._waitDestroy.push(e),e.lastOpTime=y.currentTime}hasRes(e){return this.__resDic.has(e)}getRes(e){return this.__resDic.get(e)}addRef(e,t){if(!this.__resDic.has(e))throw new Error("\u672A\u627E\u5230\u8D44\u6E90\uFF1A"+e);let i=this.__resDic.get(e),r=this._waitDestroy.indexOf(i);return r>=0&&this._waitDestroy.splice(r,1),i.lastOpTime=y.currentTime,i.addRef(t)}removeRef(e){if(!this.__resDic.has(e.key))throw new Error("\u672A\u627E\u5230\u8D44\u6E90\uFF1A"+e.key);let t=this.__resDic.get(e.key);t.removeRef(e),t.refLength==0&&this._waitDestroy.push(t),t.lastOpTime=y.currentTime}gc(e){let t,i=y.currentTime;for(let r=0;r<this._waitDestroy.length;r++)t=this._waitDestroy[r],!(t.refCount>0)&&(e==!0?(this._waitDestroy.splice(r,1),this.destroyRes(t),r--):i-t.lastOpTime>v.GC_TIME&&(this._waitDestroy.splice(r,1),this.destroyRes(t),r--))}destroyRes(e){this.__resDic.delete(e.key),e.destroy()}get resList(){return this.__resDic.elements}};var v=class{static addRes(e){this.impl.addRes(e)}static hasRes(e){return this.impl.hasRes(e)}static getRes(e){return this.impl.getRes(e)}static addRef(e,t){return this.impl.addRef(e,t)}static removeRef(e){return this.impl.removeRef(e)}static gc(e){return this.impl.gc(e)}static get resList(){return this.impl.resList}static get impl(){return this.__impl==null&&(this.__impl=g.getInject(this.KEY)),this.__impl==null&&(this.__impl=new le),this.__impl}};v.KEY="ResourceManager",v.GC_CHECK_TIME=5e3,v.GC_TIME=15e3,v.AUTO_GC=!0;import{Asset as ue,assetManager as We,instantiate as Je,isValid as ze,Prefab as Ue}from"cc";var he=class{constructor(){this.__logs=new M,this.__showed=new Map,this.__saves=new Map,this.__showed.set(_.TYPE.ALL,!0),this.__saves.set(_.TYPE.ALL,!1)}show(e,t){this.__showed.set(e,t)}save(e,t){this.__saves.set(e,t)}getLogs(e){if((e==null||e==null)&&(e=_.TYPE.ALL),this.__logs.has(e))return this.__logs.get(e)}__save(e,t,i){let r="["+e.toUpperCase()+"]"+t+": "+i,s;return this.__saves.has(e)&&(this.__logs.has(e)?s=this.__logs.get(e):(s=[],this.__logs.set(e,s)),s.length>=_.MaxCount&&s.unshift(),s.push(r)),this.__logs.has(_.TYPE.ALL)?s=this.__logs.get(_.TYPE.ALL):(s=[],this.__logs.set(_.TYPE.ALL,s)),s.length>=_.MaxCount&&s.unshift(),s.push(r),r}isShow(e){let t=this.__showed.has(_.TYPE.ALL)?this.__showed.get(_.TYPE.ALL):!1,i=this.__showed.has(e)?this.__showed.get(e):!1;return t||i}log(e,t){t=t||_.TYPE.ALL;let i=this.__save(t,"Log",e);this.isShow(t)&&console.log(i)}error(e,t){t=t||_.TYPE.ALL;let i=this.__save(t,"Error",e);this.isShow(t)&&console.error(i)}warn(e,t){t=t||_.TYPE.ALL;let i=this.__save(t,"Warn",e);this.isShow(t)&&console.warn(i)}info(e,t){t=t||_.TYPE.ALL;let i=this.__save(t,"Info",e);this.isShow(t)&&console.info(i)}};var Fe=(r=>(r.ALL="all",r.NET="net",r.RES="res",r.Module="module",r))(Fe||{}),_=class{static show(e,t){this.impl.show(e,t)}static save(e,t){this.impl.save(e,t)}static getLogs(e){return this.impl.getLogs(e)}static log(e,t){this.impl.log(e,t)}static error(e,t){this.impl.error(e,t)}static warn(e,t){this.impl.warn(e,t)}static info(e,t){this.impl.info(e,t)}static get impl(){return this.__impl==null&&(this.__impl=g.getInject(this.KEY)),this.__impl==null&&(this.__impl=new he),this.__impl}};_.TYPE=Fe,_.KEY="Logger",_.MaxCount=1e3;var q=class{constructor(){this.key="";this.refKey="";this.__isDisposed=!1}reset(){this.key="",this.refKey="",this.content=null,this.__isDisposed=!1}get isDisposed(){return this.__isDisposed}dispose(){if(this.__isDisposed)throw new Error("\u91CD\u590D\u91CA\u653E\u8D44\u6E90\u5F15\u7528");this.__isDisposed=!0}destroy(){return this.reset(),!0}};var k=class{constructor(){this.lastOpTime=0;this.__refList=[]}addRef(e){let t=E.acquire(q);return t.key=this.key,t.refKey=e||"",this.content instanceof ue?(this.content instanceof Ue?t.content=Je(this.content):t.content=this.content,this.content.addRef()):t.content=this.content,this.__refList.push(t),t}removeRef(e){let t=this.__refList.indexOf(e);if(t==-1)throw new Error("\u8D44\u6E90\u5F15\u7528\u4E0D\u5B58\u5728");if(this.content instanceof ue){if(this.content instanceof Ue){let i=e.content;ze(i)&&i.destroy()}this.content.decRef()}this.__refList.splice(t,1),E.release(q,e)}destroy(){if(this.refCount>0||this.refLength>0)throw new Error("\u53D1\u73B0\u9500\u6BC1\u8D44\u6E90\u65F6\u5F15\u7528\u6570\u91CF\u4E0D\u4E3A0");return this.content instanceof ue?(this.content.decRef(),this.content.refCount<=0&&(_.log("ReleaseAsset=>"+this.key,_.TYPE.RES),We.releaseAsset(this.content))):(_.log("DestroyAsset=>"+this.key,_.TYPE.RES),this.content.destroy&&this.content.destroy()),this.key=void 0,this.__refList=void 0,this.content=void 0,!0}get refList(){return this.__refList}get refCount(){return this.content instanceof ue?this.content.refCount-1:this.__refList.length}get refLength(){return this.__refList.length}};var $=class extends f{constructor(){super()}reset(){this.__url=void 0,this.offAllEvent()}load(e){if(this.__url=e,!this.__url)throw new Error("url is null");if(typeof this.__url=="string")we.loadRemote(this.__url,(t,i)=>{if(t){this.emit(a.ERROR,this.__url,t);return}let r=d.url2Key(e),s=new k;s.key=r,s.content=i,v.addRes(s),this.emit(a.COMPLETE,e)});else{let t=we.getBundle(this.__url.bundle);t?this.__load(this.__url,t):we.loadBundle(this.__url.bundle,(i,r)=>{if(i){this.emit(a.ERROR,this.__url,i);return}this.__load(this.__url,r)})}}__load(e,t){if(typeof e=="string")throw new Error("\u672A\u5B9E\u73B0\uFF01");let i=d.url2Path(e);t.load(i,e.type,(r,s)=>{let n=r/s;this.emit(a.PROGRESS,this.__url,void 0,n)},(r,s)=>{if(r){this.emit(a.ERROR,e,r);return}let n=d.url2Key(e),o=new k;o.key=n,o.content=s,v.addRes(o),this.emit(a.COMPLETE,e)})}};var _e=class u{constructor(){this.running=new M;this.waiting=new M;this.pool=new Map;c.addTicker(this)}tick(e){for(;this.running.size<d.MAX_LOADER_THREAD&&this.waiting.size>0;){let t=this.waiting.elements[0],i=d.url2Key(t);this.waiting.delete(i),this.__load(t,i)}}__load(e,t){let i,r,s;typeof e=="string"?s="string":s=e.type;let n=this.pool.get(s);n==null&&(n=[],this.pool.set(s,n)),n.length>0?i=n.shift():(typeof e=="string"?r=d.getLoader("string"):r=d.getLoader(e.type),i=new r),i!=null&&(this.running.set(t,i),this.__addEvent(i),_.log("Start Load:"+d.url2Key(e),_.TYPE.RES),i.load(e))}__addEvent(e){e.on(a.COMPLETE,this.__eventHandler,this),e.on(a.ERROR,this.__eventHandler,this),e.on(a.PROGRESS,this.__eventHandler,this)}__eventHandler(e){let t=e.target;if(e.type==a.PROGRESS){T.childProgress(e.data,e.progress);return}if(t.offAllEvent(),this.running.delete(d.url2Key(e.data)),e.type==a.ERROR){_.log("Load Error:"+d.url2Key(e.data)+" e: "+e.error.message,_.TYPE.RES),T.childError(e.data,e.error);return}if(e.type==a.COMPLETE){_.log("Load Complete:"+d.url2Key(e.data),_.TYPE.RES),T.childComplete(e.data),t.reset();let i;typeof e.data=="string"?i="string":i=e.data.type;let r=this.pool.get(i);r==null&&(r=[],this.pool.set(i,r)),r.push(t)}}load(e){let t=d.url2Key(e);if(typeof e!="string"&&e.isSub){this.waiting.has(t)&&this.waiting.delete(t),this.running.has(t)||this.__load(e,t);return}this.waiting.has(t)||this.running.has(t)||this.waiting.set(t,e)}static get single(){return u.__instance==null&&(u.__instance=new u),u.__instance}};var de=class{constructor(){this.__requests=new Map}load(e){if(e.urls.length==0){console.error("urls is empty!");return}this.__addReqeuset(e);for(let t=0;t<e.urls.length;t++){let i=e.urls[t],r=d.url2Key(i);v.hasRes(r)?this.childComplete(i):_e.single.load(i)}}unload(e){this.__deleteReqeuset(e)}childComplete(e){let t=d.url2Key(e),i=this.__requests.get(t);if(i){for(let r=0;r<i.length;r++)i[r].childComplete(e);i.splice(0,i.length)}this.__requests.delete(t)}childError(e,t){let i=d.url2Key(e),r=this.__requests.get(i);if(r){let s=r.concat();for(let n=0;n<s.length;n++){let o=s[n];o.childError(t),this.__deleteReqeuset(o)}}this.__requests.delete(i)}childProgress(e,t){let i=d.url2Key(e),r=this.__requests.get(i);if(r)for(let s=0;s<r.length;s++)r[s].childProgress(e,t)}__addReqeuset(e){let t;for(let i=0;i<e.urls.length;i++){let r=e.urls[i],s=d.url2Key(r);this.__requests.has(s)?t=this.__requests.get(s):(t=[],this.__requests.set(s,t)),t.push(e)}}__deleteReqeuset(e){if(!e.urls||e.urls.length==0)return;let t,i=0;for(let r=0;r<e.urls.length;r++){let s=e.urls[r],n=d.url2Key(s);this.__requests.has(n)&&(t=this.__requests.get(n),!(!t||t.length==0)&&(i=t.indexOf(e),i>=0&&t.splice(i,1)))}}};var T=class{static load(e){this.impl.load(e)}static unload(e){this.impl.unload(e)}static childComplete(e){this.impl.childComplete(e)}static childError(e,t){this.impl.childError(e,t)}static childProgress(e,t){this.impl.childProgress(e,t)}static get impl(){return this.__impl==null&&(this.__impl=g.getInject(this.KEY)),this.__impl==null&&(this.__impl=new de),this.__impl}};T.KEY="LoaderManager";var B=class u{constructor(){this.state=3;this.refKey="";this.helpMap=new Map;this.urls=[],this.__resRefs=[],this.__loaded=new Map,this.__loadProgress=new Map}init(e,t,i,r){Array.isArray(e)?this.urls=e:this.urls=[e],this.urls=this.removeDuplicates(this.urls),this.cb=r,this.refKey=t,this.progress=i}load(){this.state=2,T.load(this)}childComplete(e){let t=d.url2Key(e);this.__loaded.set(t,!0),this.checkComplete()}childProgress(e,t){let i=d.url2Key(e);this.__loadProgress.set(i,t),this.updateProgress()}childError(e){this.state=0,this.cb&&this.cb(e)}updateProgress(){let t=this.getLoaded()/this.urls.length;this.progress&&this.progress(t)}checkComplete(){if(this.__loaded.size/this.urls.length>=1&&this.cb!=null){this.state=1;for(let i=0;i<this.urls.length;i++){let r=this.urls[i],s=d.url2Key(r),n=v.addRef(s,this.refKey);this.__resRefs.push(n)}this.cb()}}getLoaded(){let e=0;for(let t of this.__loadProgress.values())e+=t;return e}reset(){if(this.state=3,this.__resRefs){for(let e=0;e<this.__resRefs.length;e++)this.__resRefs[e].dispose();this.__resRefs.splice(0,this.__resRefs.length)}this.__loaded.clear(),this.__loadProgress.clear(),this.urls=[],this.cb=void 0,this.progress=void 0}destroy(){return this.reset(),this.__resRefs.splice(0,this.__resRefs.length),this.__loaded.clear(),this.__loadProgress.clear(),!0}dispose(){this.state==2&&T.unload(this),E.release(u,this)}getRef(){return this.__resRefs[0]}getRefList(){return this.__resRefs}getRefMap(e){e=e||new Map;for(let t=0;t<this.__resRefs.length;t++){let i=this.__resRefs[t];e.set(i.key,i)}return e}removeDuplicates(e){this.helpMap.clear();let t=[];for(let i=0;i<e.length;i++){let r=e[i],s=d.url2Key(r);this.helpMap.has(s)||(this.helpMap.set(s,!0),t.push(r))}return t}};var D=class{static getWord(e,t){if(Array.isArray(t)&&t.length>0){let i=[];for(let r of t)i.push(this.getWord(e,r).toString());return i}else{let i=e.match(new RegExp("^(?:\\w+\\W+){"+t+"}(\\w+)"));return i?i[1]:""}}static getContractName(e){let t=this.getWord(e,[0,1,2]);return t[0]==="abstract"?t[2]:t[1]}static getFunctionName(e){let t=this.getWord(e,[0,1]);return t[0]==="constructor"?t[0]:t[1]}static getClassName(e){let t;return typeof e!="string"?(t=e.toString(),t.startsWith("function")?this.getFunctionName(t):this.getContractName(t)):(t=e,t)}};var me=class{constructor(){this.__assetTypes=new Map;this.loaderClass=new Map}url2Key(e){if(e==null||e==null)return"";if(typeof e=="string")return e;let t;return e.type==Ke?t=e.url+"/spriteFrame":e.type==$e?t=e.url+"/texture":t=e.url,t+"|"+e.bundle+"|"+this.getAndSaveClassName(e.type)}key2Url(e){if(e.indexOf("|")){let t=e.split("|");return{url:this.path2Key(t[0]),bundle:t[1],type:this.getAssetType(t[2])}}return e}url2Path(e){return typeof e=="string"?e:e.type==$e?e.url+"/texture":e.type==Ke?e.url+"/spriteFrame":e.url}urlEqual(e,t){return e==t?!0:e==null||t==null?!1:typeof e=="string"&&typeof t=="string"?e==t:typeof e=="string"||typeof t=="string"?!1:e.url==t.url&&e.type==t.type&&e.bundle==t.bundle}getAssetType(e){if(!this.__assetTypes.has(e))throw new Error("\u672A\u627E\u5230\u5BF9\u5E94\u8D44\u6E90\u7C7B\u578B\uFF1A"+e);return this.__assetTypes.get(e)}getAndSaveClassName(e){let t=D.getClassName(e);return this.__assetTypes.has(t)||this.__assetTypes.set(t,e),t}path2Key(e){let t=e.length,i=t-8,r=e.substring(i);return r==="/texture"||(i=t-12,r=e.substring(i),r==="/spriteFrame")?e.substring(0,i):e}setLoader(e,t){let i=D.getClassName(e);this.loaderClass.set(i,t)}getLoader(e){let t=D.getClassName(e);return this.loaderClass.has(t)?this.loaderClass.get(t):$}create(e,t,i,r){let s=E.acquire(B);return s.init(e,t,i,r),s}loadAssetBundles(e){let t=[];typeof e=="string"?t.push(e):t.push(...e);let i=[];for(let o=0;o<t.length;o++){let l=t[o];!Ve.getBundle(l)&&i.indexOf(l)==-1&&i.push(l)}let r=0,s=i.length;return new Promise((o,l)=>{for(let h=0;h<i.length;h++){let m=i[h];Ve.loadBundle(m,(p,A)=>{if(p){l(p);return}r++,r==s&&o()})}})}};var Be=(t=>(t.FGUI="fgui",t.CONFIG="config",t))(Be||{}),d=class{static key2Url(e){return this.impl.key2Url(e)}static url2Key(e){return this.impl.url2Key(e)}static url2Path(e){return this.impl.url2Path(e)}static urlEqual(e,t){return this.impl.urlEqual(e,t)}static setLoader(e,t){this.impl.setLoader(e,t)}static getLoader(e){return this.impl.getLoader(e)}static create(e,t,i,r){return this.impl.create(e,t,i,r)}static loadAssetBundles(e){return this.impl.loadAssetBundles(e)}static get impl(){return this.__impl==null&&(this.__impl=g.getInject(this.KEY)),this.__impl==null&&(this.__impl=new me),this.__impl}};d.KEY="Res",d.TYPE=Be,d.MAX_LOADER_THREAD=5;var G=class{constructor(e,t){this.__reqeust=null;t==null&&(t=e.addComponent(Qe)),this.__node=e,this.__source=t}get url(){return this.__url}get mute(){return this.__mute}set mute(e){this.__mute!=e&&(this.__mute=e,this.__mute?(this.__volume=this.__source.volume,this.__source.volume=0):this.__source.volume=this.__volume)}play(e,t,i,r,s=!1,n=1){this.__reset(),this.__url=e,this.__playedComplete=t,this.__isPlaying=!0,this.__speed=n,this.__loop=s,r?(r.time<=0&&(this.mute?this.__volume=i:this.__source.volume=i),this.__fadeData==null&&(this.__fadeData=new ce),this.__fadeData.startTime=y.currentTime,this.__fadeData.startValue=r.startVolume==null?this.__source.volume:r.startVolume,this.__fadeData.time=r.time,this.__fadeData.endValue=i,this.__fadeData.complete=r.complete,this.__fadeData.completeStop=r.completeStop):this.__volume=i,this.__startTime=y.currentTime,this.__time=Number.MAX_VALUE,this.__reqeust&&(this.__reqeust.dispose(),this.__reqeust=null),this.__reqeust=d.create(this.url,"AudioChannel",void 0,o=>{if(o){this.__reqeust.dispose(),this.__reqeust=null,_.error(o,_.TYPE.RES),this.__isPlaying=!1,this.__source.stop();return}this.__isPlaying!=!1&&this.__play()}),this.__reqeust.load()}stop(){this.__source.playing&&this.__source.stop(),this.__isPlaying=!1,this.__reset()}get isPlaying(){return this.__isPlaying||this.__source.playing}fade(e,t,i,r,s){this.isPlaying&&(this.__paused=!1,e<=0?(this.mute?this.__volume=t:this.__source.volume=t,s&&(this.stop(),r&&r())):(this.__fadeData==null&&(this.__fadeData=new ce),this.__fadeData.startTime=y.currentTime,this.__fadeData.startValue=i==null?this.__source.volume:i,this.__fadeData.time=e,this.__fadeData.endValue=t,this.__fadeData.complete=r,this.__fadeData.completeStop=s))}__reset(){this.__url=null,this.__reqeust&&(this.__reqeust.dispose(),this.__reqeust=null),this.__isPlaying=!1,this.__paused=!1,this.__fadeData=null}__play(){this.__source.clip=this.__reqeust.getRef().content,this.__source.loop=this.__loop,this.__source.play();let e=y.currentTime;this.__fadeData?(this.__fadeData.startTime=e,this.mute?this.__volume=this.__fadeData.startValue:this.__source.volume=this.__fadeData.startValue):this.mute?this.__source.volume=0:this.__source.volume=this.__volume,this.__startTime=y.currentTime,this.__time=this.__source.duration*1e3}tick(e){if(this.__paused||this.__isPlaying==!1||this.__url==null)return;let t=y.currentTime,i;if(this.__fadeData){i=t-this.__fadeData.startTime;let s=i/this.__fadeData.time;if(s=s>1?1:s,this.mute?this.__volume=this.__fadeData.startValue+(this.__fadeData.endValue-this.__fadeData.startValue)*s:this.__source.volume=this.__fadeData.startValue+(this.__fadeData.endValue-this.__fadeData.startValue)*s,s==1){let n=this.__fadeData.complete;this.__fadeData.completeStop&&(this.__source.stop(),this.__isPlaying=!1,this.__reset()),n&&n(),this.__fadeData=null}}if(this.__loop)return;i=t-this.__startTime,i/this.__time>=1&&(this.__source.stop(),this.__isPlaying=!1,this.__playedComplete&&this.__playedComplete(),this.__reset())}resume(){if(this.__paused==!1)return;let e=y.currentTime-this.__pauseTime;this.__fadeData&&(this.__fadeData.startTime+=e),this.__startTime+=e,this.__source.play(),this.__paused=!1}pause(){this.__paused||(this.__paused=!0,this.__pauseTime=y.currentTime,this.__source.pause())}get curVolume(){return this.__source.volume}},ce=class{};var pe=class{constructor(){this.__musicChannelIndex=0;this.__volume=1;this.__musicVolume=1;this.__musicChannels=[],this.__soundChannels=[],c.addTicker(this),this.__audioRoot=et("AudioManager"),this.__audioRoot==null&&(this.__audioRoot=new tt("AudioManager"),Ze.getScene().addChild(this.__audioRoot));let e;for(let t=0;t<2;t++)e=new G(this.__audioRoot),this.__musicChannels.push(e)}get volume(){return this.__volume}set volume(e){if(this.__volume==e)return;this.__volume=e;let t,i;for(let r=0;r<this.__musicChannels.length;r++)i=this.__musicChannels[r],i.isPlaying&&(t=i.volume*this.__musicVolume*this.__volume,i.fade(.1,t,i.curVolume));for(let r=0;r<this.__soundChannels.length;r++)i=this.__soundChannels[r],i.isPlaying&&(t=i.volume*this.__soundVolume*this.__volume,i.fade(.1,t,i.curVolume))}set musicVolume(e){if(this.__musicVolume==e||(this.__musicVolume=e,this.muteMusic))return;let t=this.__musicChannels[this.__musicChannelIndex];if(t&&t.isPlaying){let i=t.volume*this.__musicVolume*this.__volume;t.fade(.1,i,t.curVolume)}}get musicVolume(){return this.__musicVolume}get soundVolume(){return this.__soundVolume}set soundVolume(e){if(this.__soundVolume==e)return;this.__soundVolume=e;let t;for(let i=0;i<this.__soundChannels.length;i++)if(t=this.__soundChannels[i],t.isPlaying){let r=t.volume*this.__soundVolume*this.__volume;t.fade(.1,r,t.curVolume)}}set mute(e){this.__mute!=e&&(this.__mute=e,this.__changedMutes())}get mute(){return this.__mute}get muteMusic(){return this.__muteMusic}set muteMusic(e){this.__muteMusic!=e&&(this.__muteMusic=e,this.__changedMutes())}get muteSound(){return this.__muteSound}set muteSound(e){this.__muteSound!=e&&(this.__muteSound=e,this.__changedMutes())}__changedMutes(){for(let e=0;e<this.__musicChannels.length;e++){let t=this.__musicChannels[e];t.mute=this.muteMusic||this.mute}for(let e=0;e<this.__soundChannels.length;e++){let t=this.__soundChannels[e];t.mute=this.muteSound||this.mute}}playMusic(e,t,i){let r;this.muteMusic||this.mute?r=0:r=t*this.__musicVolume*this.__volume;let s=this.__musicChannels[this.__musicChannelIndex];if(s&&s.isPlaying&&d.urlEqual(s.url,e))return;this.__musicChannelIndex++,this.__musicChannelIndex=this.__musicChannelIndex%2;let n;this.__musicChannelIndex==0?(s=this.__musicChannels[0],n=this.__musicChannels[1]):(s=this.__musicChannels[1],n=this.__musicChannels[0]),n.isPlaying&&n.fade(.5,0,void 0,null,!0),s.volume=t,s.play(e,null,r,{time:.5,startVolume:0},!0,i)}stopMusic(){let e=this.__musicChannels[this.__musicChannelIndex];e&&e.isPlaying&&e.stop()}pauseMusic(){let e=this.__musicChannels[this.__musicChannelIndex];e&&e.pause()}resumeMusic(){let e=this.__musicChannels[this.__musicChannelIndex];e&&e.resume()}playSound(e,t,i,r,s){let n;this.muteSound||this.mute?n=0:n=this.soundVolume*i*this.__volume;let o=this.GetIdleChannel();o&&(o.volume=i,o.play(e,t,n,null,s,r))}getPlaying(e){for(let t=0;t<this.__soundChannels.length;t++){let i=this.__soundChannels[t];if(i.isPlaying&&d.urlEqual(i.url,e))return i}return null}GetIdleChannel(){let e,t;for(e=0;e<this.__soundChannels.length;e++)if(t=this.__soundChannels[e],t.isPlaying==!1)return t;return e<O.MAX_SOUND_CHANNEL_COUNT?(t=new G(this.__audioRoot),this.__soundChannels.push(t),t):null}tick(e){for(let t=0;t<this.__musicChannels.length;t++){let i=this.__musicChannels[t];i.isPlaying&&i.tick(e)}for(let t=0;t<this.__soundChannels.length;t++){let i=this.__soundChannels[t];i.isPlaying&&i.tick(e)}}};var O=class{static get volume(){return this.impl.volume}static set volume(e){this.impl.volume=e}static get musicVolume(){return this.impl.musicVolume}static set musicVolume(e){this.impl.musicVolume=e}static get soundVolume(){return this.impl.soundVolume}static set soundVolume(e){this.impl.soundVolume=e}static get mute(){return this.impl.mute}static set mute(e){this.impl.mute=e}static get muteMusic(){return this.impl.muteMusic}static set muteMusic(e){this.impl.muteMusic=e}static get muteSound(){return this.impl.muteSound}static set muteSound(e){this.impl.muteSound=e}static playMusic(e,t=1,i=1){this.impl.playMusic(e,t,i)}static stopMusic(){this.impl.stopMusic()}static pauseMusic(){this.impl.pauseMusic()}static resumeMusic(){this.impl.resumeMusic()}static playSound(e,t,i=1,r=1,s=!1){this.impl.playSound(e,t,i,r,s)}static getPlaying(e){return this.impl.getPlaying(e)}static get impl(){return this.__impl==null&&(this.__impl=g.getInject(this.KEY)),this.__impl==null&&(this.__impl=new pe),this.__impl}};O.KEY="AudioManager",O.MAX_SOUND_CHANNEL_COUNT=30;var Ce=class{equal(e,t,i){return!(this.functionName!=e||t&&!t.equal(this.preHandler)||i&&!i.equal(this.laterHandler))}},Y=class{constructor(e){this.data=e,this.__functions=[],this.__preHandlerMap=new Map,this.__laterHandlerMap=new Map,this.__groupMap=new Map}addHook(e,t,i,r){let s=this.__groupMap.get(e);s||(s=[],this.__groupMap.set(e,s));for(let m=0;m<s.length;m++)if(s[m].equal(t,i,r))return;let n=new Ce;n.functionName=t,n.preHandler=i,n.laterHandler=r,s.push(n);let o=this;if(this.__functions.indexOf(t)<0){let m=this.data[t];if(!m)throw new Error("\u65B9\u6CD5\u4E0D\u5B58\u5728\uFF01");let p=this.__preHandlerMap.get(t);p||(p=[],this.__preHandlerMap.set(t,p));let A=this.__laterHandlerMap.get(t);A||(A=[],this.__laterHandlerMap.set(t,A));let Xe=function(...Ie){if(p&&p.length)for(let P=0;P<p.length;P++){let K=p[P];K&&K.run(Ie)}if(m.apply(o.data,Ie),A&&A.length)for(let P=0;P<A.length;P++){let K=A[P];K&&K.run(Ie)}};this.data[t]=Xe,this.data["old_"+t]=m,this.__functions.push(t)}let l=this.__preHandlerMap.get(t);l||(l=[],this.__preHandlerMap.set(t,l)),l.indexOf(i)<0&&l.push(i);let h=this.__laterHandlerMap.get(t);h||(h=[],this.__laterHandlerMap.set(t,h)),h.indexOf(r)<0&&h.push(r)}removeHook(e,t,i,r){let s=this.__groupMap.get(e);if(!s)return;let n,o;if(!t){for(let l=0;l<s.length;l++){let h=s[l];h.preHandler&&(n=this.__preHandlerMap.get(h.functionName),o=n.indexOf(h.preHandler),o>=0&&n.splice(o,1),n.length==0&&this.__preHandlerMap.delete(h.functionName)),h.laterHandler&&(n=this.__laterHandlerMap.get(h.functionName),o=n.indexOf(h.laterHandler),o>=0&&n.splice(o,1),n.length==0&&this.__laterHandlerMap.delete(h.functionName))}s.length=0,this.__groupMap.delete(e);return}for(let l=0;l<s.length;l++){let h=s[l];if(h.equal(t,i,r)){s.splice(l,1),h.preHandler&&(n=this.__preHandlerMap.get(t),o=n.indexOf(h.preHandler),o>=0&&n.splice(o,1)),h.laterHandler&&(n=this.__laterHandlerMap.get(t),o=n.indexOf(h.laterHandler),o>=0&&n.splice(o,1));return}}}};var fe=class{constructor(e,t,i){this.property=e,this.targetOrCallBack=t,this.tPropertyOrCaller=i}equal(e,t,i){return e==this.property&&this.targetOrCallBack==t&&this.tPropertyOrCaller==i}},j=class{constructor(e){this.data=e,this.__propertys=[],this.__changedPropertys=[],this.__bindedMap=new Map,this.__bindedGroupMap=new Map}bind(e,t,i,r){let s,n=this.__bindedGroupMap.get(e);n||(n=[],this.__bindedGroupMap.set(e,n));let o=!1,l;if(Array.isArray(t))for(let h=0;h<t.length;h++){let m=t[h];this.__checkProperty(m);for(let p=0;p<n.length;p++)if(s=n[p],s.equal(m,i,r)){o=!0;continue}o||(s=new fe(m,i,r),l=this.__bindedMap.get(m),l||(l=[],this.__bindedMap.set(m,l)),l.push(s),n.push(s),this.__propertyChanged(m))}else{this.__checkProperty(t);for(let h=0;h<n.length;h++)if(s=n[h],s.equal(t,i,r))return;s=new fe(t,i,r),l=this.__bindedMap.get(t),l||(l=[],this.__bindedMap.set(t,l)),l.push(s),n.push(s),this.__propertyChanged(t)}}unbind(e,t,i,r){let s,n=this.__bindedGroupMap.get(e);if(!n)return;let o,l;if(t==null){for(let h=0;h<n.length;h++)s=n[h],o=this.__bindedMap.get(s.property),o&&o.length>0&&(l=o.indexOf(s),l>=0&&o.splice(l,1)),o.length==0&&this.__bindedMap.delete(s.property);n.length=0,this.__bindedGroupMap.delete(e);return}if(Array.isArray(t)){for(let h=0;h<t.length;h++){let m=t[h];for(let p=0;p<n.length;p++)s=n[p],o=this.__bindedMap.get(s.property),s.equal(m,i,r)&&(l=o.indexOf(s),l>=0&&o.splice(l,1),n.splice(p,1),p--)}n.length==0&&this.__bindedGroupMap.delete(e)}else{for(let h=0;h<n.length;h++)s=n[h],o=this.__bindedMap.get(s.property),s.equal(t,i,r)&&(l=o.indexOf(s),l>=0&&o.splice(l,1),n.splice(h,1),h--);n.length==0&&this.__bindedGroupMap.delete(e)}}__checkProperty(e){if(this.__propertys.indexOf(e)<0){let i=this.data[e];this.__defineReactive(this.data,e,i),this.__propertys.push(e)}}__defineReactive(e,t,i){let r=this;Object.defineProperty(e,t,{enumerable:!0,configurable:!0,get:function(){return i},set:function(s){i!=s&&(i=s,r.__propertyChanged(t))}})}__propertyChanged(e,t=!1){this.__changedPropertys.indexOf(e)<0&&(this.__changedPropertys.push(e),c.callNextFrame(this.__nextFramePropertyUpdate,this))}__nextFramePropertyUpdate(e=!1){let t;for(let i=0;i<this.__changedPropertys.length;i++)t=this.__changedPropertys[i],this.__updateProperty(t);this.__changedPropertys.length=0}__updateProperty(e){let t=this.__bindedMap.get(e),i;if(t&&t.length)for(let r=0;r<t.length;r++)i=t[r],typeof i.targetOrCallBack!="function"?i.targetOrCallBack[i.tPropertyOrCaller]=this.data[e]:i.targetOrCallBack.apply(i.tPropertyOrCaller,[this.__changedPropertys])}};var ke=class{constructor(){this.__bindRecords=[],this.__hookRecords=[],this.__eventRecords=[],this.inited=!1}init(){this.inited=!0}__bind(e,t,i,r){for(let s=0;s<this.__bindRecords.length;s++){let n=this.__bindRecords[s];if(n.source==e&&n.property==t&&n.targetOrCallback==i&&n.targetPropertyOrCaller==r)throw new Error("\u91CD\u590D\u7ED1\u5B9A\uFF1A"+e+t+i+r)}this.__bindRecords.push({source:e,property:t,targetOrCallback:i,targetPropertyOrCaller:r}),w.bind(this,e,t,i,r)}__unbind(e,t,i,r){for(let s=0;s<this.__bindRecords.length;s++){let n=this.__bindRecords[s];n.source==e&&n.property==t&&n.targetOrCallback==i&&n.targetPropertyOrCaller==r&&this.__bindRecords.splice(s,1)}w.unbind(this,e,t,i,r)}__addHook(e,t,i,r){for(let s=0;s<this.__hookRecords.length;s++){let n=this.__hookRecords[s];if(n.source==e&&n.functionName==t&&i.equal(n.preHandler)&&r.equal(n.laterHandler))throw new Error("\u91CD\u590D\u7ED1\u5B9A\uFF1A"+e+" "+t)}this.__hookRecords.push({source:e,functionName:t,preHandler:i,laterHandler:r}),w.addHook(this,e,t,i,r)}__removeHook(e,t,i,r){for(let s=0;s<this.__hookRecords.length;s++){let n=this.__hookRecords[s];n.source==e&&n.functionName==t&&i.equal(n.preHandler)&&r.equal(n.laterHandler)&&this.__hookRecords.splice(s,1)}w.removeHook(this,e,t,i,r)}bindAA(e,t,i,r){this.__bind(e,t,i,r)}unbindAA(e,t,i,r){this.__unbind(e,t,i,r)}bindAM(e,t,i,r){this.__bind(e,t,i,r)}unbidAM(e,t,i,r){this.__unbind(e,t,i,r)}bindMM(e,t,i,r){this.__addHook(e,t,i,r)}unbindMM(e,t,i,r){this.__removeHook(e,t,i,r)}bindEvent(e,t,i,r){for(let s=0;s<this.__eventRecords.length;s++){let n=this.__eventRecords[s];if(n.target==e&&n.eventType==t&&n.handler==i&&n.caller==r)throw new Error("\u91CD\u590D\u7ED1\u5B9AUI\u4E8B\u4EF6\uFF1A"+e+t+i+r)}if(this.inited){let s=e.on;s&&typeof s=="function"&&e.on(t,i,r),this.__eventRecords.push({target:e,eventType:t,handler:i,caller:r})}else this.__eventRecords.push({target:e,eventType:t,handler:i,caller:r})}unbindEvent(e,t,i,r){let s=e.off;s&&typeof s=="function"&&e.off(t,i,r);for(let n=0;n<this.__eventRecords.length;n++){let o=this.__eventRecords[n];o.target==e&&o.eventType==t&&o.handler==i&&o.caller==r&&this.__eventRecords.splice(n,1)}}bindByRecords(){for(let e=0;e<this.__bindRecords.length;e++){let t=this.__bindRecords[e];w.bind(this,t.source,t.property,t.targetOrCallback,t.targetPropertyOrCaller)}for(let e=0;e<this.__hookRecords.length;e++){let t=this.__hookRecords[e];w.addHook(this,t.source,t.functionName,t.preHandler,t.laterHandler)}for(let e=0;e<this.__eventRecords.length;e++){let t=this.__eventRecords[e],i=t.target.hasEventHandler;if(i&&typeof i=="function"&&t.target.hasEventHandler(t.eventType,t.handler,t.caller))continue;let r=t.target.on;r&&typeof r=="function"&&t.target.on(t.eventType,t.handler,t.caller)}}unbindByRecords(){for(let e=0;e<this.__bindRecords.length;e++){let t=this.__bindRecords[e];w.unbind(this,t.source,t.property,t.targetOrCallback,t.targetPropertyOrCaller)}for(let e=0;e<this.__hookRecords.length;e++){let t=this.__hookRecords[e];w.removeHook(this,t.source,t.functionName,t.preHandler,t.laterHandler)}for(let e=0;e<this.__eventRecords.length;e++){let t=this.__eventRecords[e];t.target.off(t.eventType,t.handler,t.caller)}}destroy(){this.unbindByRecords(),this.__bindRecords=null,this.__hookRecords=null,this.__eventRecords=null}},w=class{constructor(){}static bind(e,t,i,r,s){let n=t.$PropertyBinder;n||(n=new j(t),t.$PropertyBinder=n),n.bind(e,i,r,s)}static unbind(e,t,i,r,s){let n=t.$PropertyBinder;n&&n.unbind(e,i,r,s)}static addHook(e,t,i,r,s){let n=t.$FunctionHook;n||(n=new Y(t),t.$FunctionHook=n),n.addHook(e,i,r,s)}static removeHook(e,t,i,r,s){let n=t.$FunctionHook;n&&n.removeHook(e,i,r,s)}};var Le=class extends f{constructor(t=!0){super();this.__only=!1;this.count=0;this.__only=t,this.__element=[]}push(t){return this.__only&&this.__element.indexOf(t)>=0?!1:(this.__element.push(t),this.count=this.__element.length,this.hasEvent(a.ADD)&&this.emit(a.ADD,t),!0)}unshift(t){return this.__only&&this.__element.indexOf(t)>=0?!1:(this.__element.unshift(t),this.count=this.__element.length,this.hasEvent(a.ADD)&&this.emit(a.ADD,t),!0)}pop(){if(this.__element.length>0){let t=this.__element.pop();return this.count=this.__element.length,this.hasEvent(a.REMOVE)&&this.emit(a.REMOVE,t),t}return null}shift(){if(this.__element.length>0){let t=this.__element.shift();return this.count=this.__element.length,this.hasEvent(a.REMOVE)&&this.emit(a.REMOVE,t),t}return null}removeAt(t){if(t>=this.__element.length)throw new Error("\u5220\u9664\u7D22\u5F15\u8D85\u51FA\u8303\u56F4\uFF01");let i=this.__element[t];return this.__element.splice(t,1),this.count=this.__element.length,this.hasEvent(a.REMOVE)&&this.emit(a.REMOVE,i),i}remove(t){let i=this.__element.indexOf(t);if(i<0)throw new Error("\u8981\u5220\u9664\u7684\u5185\u5BB9\u4E0D\u5728\u5217\u8868\u4E2D\uFF01"+t);let r=this.__element[i];this.__element.splice(i,1),this.count=this.__element.length,this.hasEvent(a.REMOVE)&&this.emit(a.REMOVE,r)}clear(){this.count=0,this.__element.length=0,this.hasEvent(a.CLEAR)&&this.emit(a.CLEAR)}has(t){return this.find(t)>=0}find(t){return this.__element.indexOf(t)}findIndex(t){return this.__element.findIndex(t)}get(t){if(t>=this.__element.length)throw new Error("\u8D85\u51FA\u7D22\u5F15\u8303\u56F4:"+t+"/"+this.__element.length);return this.__element[t]}get elements(){return this.__element}};import{DEBUG as Ge}from"cc/env";var L=class extends f{constructor(t){super();this.parent=null;this.__isActive=!1;this.id=t,this.__children=[]}addChild(t){this.__children=this.__children||[],t.parent=this,this.__children.push(t),this.childrenChanged()}removeChild(t){this.__children=this.__children||[],t.parent=null;let i=this.__children.indexOf(t);i!==-1&&this.__children.splice(i,1),this.childrenChanged()}get children(){return this.__children}set isActive(t){this.__isActive=t,this.parent&&this.parent.childrenChanged(),this.emit(a.UPDATE)}childrenChanged(){c.callNextFrame(this.__childrenChanged,this)}__childrenChanged(){let t=!1;for(let i=0;i<this.__children.length;i++)if(this.__children[i].isActive){t=!0;break}this.isActive=t}get isActive(){return this.__isActive}};var X=class X{constructor(){this.__redPoints=new Map;this.__detectors=new Map;this.__waiting=new Set;this.__frameRunList=[];c.addTicker(this)}tick(e){if(this.__waiting.size==0)return;let t=0;for(let i of this.__waiting){let s=this.__detectors.get(i)(),n=this.__redPoints.get(i);if(n.isActive=s,this.__frameRunList.push(i),t>X.FRAME_RUN_COUNT)break;t++}for(let i=0;i<this.__frameRunList.length;i++){let r=this.__frameRunList[i];this.__waiting.delete(r)}this.__frameRunList.splice(0,this.__frameRunList.length)}register(e,t){if(this.__detectors.has(e))throw new Error(`\u91CD\u590D\u6CE8\u518C\u7EA2\u70B9\u68C0\u6D4B${e}`);this.__detectors.set(e,t)}unregister(e){this.__detectors.delete(e)}request(e){if(!this.__detectors.has(e))throw new Error(`\u68C0\u6D4B\u5668${e}\u4E0D\u5B58\u5728`);this.__waiting.add(e)}createByConfig(e){for(let t=0;t<e.length;t++){let i=e[t],r=this.__createNode(i.id);this.__redPoints.set(i.id,r)}for(let t=0;t<e.length;t++){let i=e[t];if(i.id==i.parent)continue;let r=this.__redPoints.get(i.id),s=this.__redPoints.get(i.parent);r.parent=s,s.addChild(r)}if(Ge){let t=[];for(let i=0;i<e.length;i++){let r=e[i],s=this.__redPoints.get(r.id);t.splice(0,t.length),this.checkCircularReference(s,t)}}}createByData(e){let t=new L(e.id);for(let i of e.children)if(typeof i=="number"){let r;this.__redPoints.has(i)?r=this.__redPoints.get(i):r=new L(i),t.addChild(r)}else{let r=i,s=this.createByData(r);t.addChild(s)}return t}create(e,t){if(this.__redPoints.has(e))throw new Error(`\u8282\u70B9${e}\u5DF2\u5B58\u5728`);let i=new L(e);for(let r=0;r<t.length;r++){let s=t[r];if(s==e)throw new Error(`\u8282\u70B9${e}\u4E0D\u80FD\u5305\u542B\u81EA\u5DF1`);let n;this.__redPoints.has(s)?n=this.__redPoints.get(s):n=this.__createNode(s),i.addChild(n)}if(this.__redPoints.set(e,i),Ge){let r=[];this.checkCircularReference(i,r)}return i}__createNode(e){let t=new L(e);return this.__redPoints.set(e,t),t}checkCircularReference(e,t){if(t.indexOf(e.id)>=0)throw new Error(`\u8282\u70B9${e.id}\u5B58\u5728\u5FAA\u73AF\u5F15\u7528`);t.push(e.id);for(let i=0;i<e.children.length;i++){let r=e.children[i];r.children.length>0&&this.checkCircularReference(r,t)}}getNode(e){return this.__redPoints.get(e)}static get single(){return this.__instance&&(this.__instance=new X),this.__instance}};X.FRAME_RUN_COUNT=2;var N=X;import{DEBUG as it}from"cc/env";var W=class extends f{constructor(t){super();this.__isActive=!1;this.__children=[];this.id=t}addChild(t){t.parent=this,this.__children.push(t)}removeChild(t){let i=this.__children.indexOf(t);i>-1&&(this.__children.splice(i,1),t.parent=null)}get children(){return this.__children}update(t){if(this.server=t,!J.single.checkFunc(this)){this.isActive=!1;return}let r=this.parent;for(;r;){if(!r.isActive){this.isActive=!1;break}r=r.parent}this.isActive=!0;for(let s=0;s<this.__children.length;s++){let n=this.__children[s];n.update(n.server)}}set isActive(t){this.__isActive!=t&&(this.__isActive=t,this.emit(a.UPDATE))}get isActive(){return!1}};var J=class u extends f{constructor(){super();this.checkFunc=t=>!!t.server;this.__funcs=new Map}init(t){for(let i=0;i<t.length;i++){let r=t[i],s=this.__createNode(r.id,r);this.__funcs.set(r.id,s)}for(let i=0;i<t.length;i++){let r=t[i];if(r.id==r.parent)continue;let s=this.__funcs.get(r.id),n=this.__funcs.get(r.parent);s.parent=n,n.addChild(s)}if(it){let i=[];for(let r=0;r<t.length;r++){let s=t[r],n=this.__funcs.get(s.id);i.splice(0,i.length),this.__checkCircularReference(n,i)}}}update(t){if(Array.isArray(t))for(let i=0;i<t.length;i++){let r=t[i];this.__update(r)}else this.__update(t)}__update(t){let i=this.__funcs.get(t.id);i.update(t),this.emit(a.UPDATE,i)}__checkCircularReference(t,i){if(i.indexOf(t.id)>=0)throw new Error(`\u8282\u70B9${t.id}\u5B58\u5728\u5FAA\u73AF\u5F15\u7528`);i.push(t.id);for(let r=0;r<t.children.length;r++){let s=t.children[r];this.__checkCircularReference(s,i)}}__createNode(t,i){let r=new W(t);return r.config=i,r}getNode(t){return this.__funcs.get(t)}static get single(){return this.__instance||(this.__instance=new u),this.__instance}};import{Component as st}from"cc";var ge=class{constructor(){this.__accessors=new Map}register(e,t){if(this.__accessors.has(e)){if(this.__accessors.get(e)!=t)throw new Error(`${e},\u91CD\u590D\u6CE8\u518C\u914D\u7F6E\u8868\u5B58\u53D6\u5668\u4E14\u5B58\u53D6\u5668\u7C7B\u578B\u4E0D\u4E00\u81F4!`);return}this.__accessors.set(e,t)}unregister(e){this.__accessors.delete(e)}getAccessorClass(e){if(!this.__accessors.has(e))throw new Error(`${e},\u914D\u7F6E\u8868\u5B58\u53D6\u5668\u672A\u6CE8\u518C!`);return this.__accessors.get(e)}getAccessor(e){if(d.sheet2URL==null)throw new Error("Res.sheet2URL\u672A\u5B9A\u4E49!\u8BF7\u5728\u521D\u59CB\u5316\u524D\u8BBE\u7F6E!");let t=d.sheet2URL(e),i=d.url2Key(t);if(!v.hasRes(i))throw new Error(e+"\u672A\u52A0\u8F7D!");return v.getRes(i).content}};var x=class{static register(e,t){this.impl.register(e,t)}static unregister(e){this.impl.unregister(e)}static getAccessorClass(e){return this.impl.getAccessorClass(e)}static getAccessor(e){return this.impl.getAccessor(e)}static get impl(){return this.__impl==null&&(this.__impl=g.getInject(this.KEY)),this.__impl==null&&(this.__impl=new ge),this.__impl}};x.KEY="ConfigManager";import{Node as rt}from"cc";import{assetManager as Ye}from"cc";var ye=class{constructor(e){this.refCount=0;this.module=e,this.refCount=0}addRef(){this.refCount++}removeRef(){this.refCount--}destroy(){return this.module.destroy(),this.module=null,!0}};var z=class extends f{constructor(){super();this.resRequest=null}load(t){this.module_name=t;let i=R.single.node.getComponent("Module_"+this.module_name);if(i){if(!(i instanceof F))throw new Error("\u6A21\u5757Module_"+this.module_name+"\u5FC5\u987B\u7EE7\u627FModule\u7C7B");this.module=i,this.__initModule()}else{_.log("Start Load Module:"+this.module_name);let r=Ye.getBundle(t);r?this.__bundleLoaded(null,r):Ye.loadBundle(t,this.__bundleLoaded.bind(this))}}__bundleLoaded(t,i){if(t){this.emit(a.ERROR,this.module_name,new Error("AssetBundle:"+this.module_name+"\u4E0D\u5B58\u5728\uFF01"));return}try{this.module=R.single.node.addComponent("Module_"+this.module_name)}catch(r){throw new Error("\u6A21\u5757Module_"+this.module_name+"\u521D\u59CB\u5316\u62A5\u9519:"+r)}if(this.module.module_name=this.module_name,!this.module)throw new Error("\u6A21\u5757\u7C7BModule_"+this.module_name+"\u4E0D\u5B58\u5728\uFF01");if(!(this.module instanceof F))throw new Error("\u6A21\u5757Module_"+this.module_name+"\u5FC5\u987B\u7EE7\u627FModule\u7C7B");try{this.__initModule()}catch(r){_.error("Load Module Error:"+this.module_name)}}__initModule(){let t=[];if(this.module.configs&&this.module.configs.length>0)for(let i=0;i<this.module.configs.length;i++){let r=this.module.configs[i],s=d.sheet2URL(r);t.push(s)}if(this.module.assets&&this.module.assets.length>0)for(let i=0;i<this.module.assets.length;i++){let r=this.module.assets[i];t.push(r)}t.length>0?(this.resRequest=d.create(t,this.module.name,i=>{this.emit(a.PROGRESS,this.module_name,void 0,i*.7)},i=>{if(i){this.resRequest.dispose(),this.resRequest=null,this.emit(a.ERROR,this.module_name,i);return}this.__assetReady()}),this.resRequest.load()):this.__assetReady()}__assetReady(){this.module.resRequest=this.resRequest,this.module.preInit();let t=new ye(this.module);this.emit(a.COMPLETE,{module:this.module_name,proxy:t})}reset(){this.module_name=null,this.module=null}};var ve=class u{constructor(){this.running=new M;this.waiting=[];c.addTicker(this)}load(e,t){if(this.running.has(e))return;let i=this.waiting.indexOf(e);if(t&&i>=0){this.waiting.splice(i,1),this.__startLoad(e);return}i>=0||this.waiting.push(e)}tick(e){for(;this.running.size<R.MAX_LOADER_THREAD&&this.waiting.length>0;){let t=this.waiting.shift();this.__startLoad(t)}}__startLoad(e){let t=E.acquire(z);this.running.set(e,t),this.__addEvent(t),t.load(e)}__addEvent(e){e.on(a.COMPLETE,this.__eventHandler,this),e.on(a.ERROR,this.__eventHandler,this),e.on(a.PROGRESS,this.__eventHandler,this)}__eventHandler(e){let t=e.target;if(e.type==a.PROGRESS){R.single.childProgress(e.data,e.progress);return}if(t.offAllEvent(),e.type==a.ERROR){this.running.delete(e.data),R.single.childError(e.data,e.error);return}e.type==a.COMPLETE&&(this.running.delete(e.data.module),R.single.childComplete(e.data.module,e.data.proxy),t.reset(),E.release(z,t))}static get single(){return this.instance==null&&(this.instance=new u),this.instance}};var be=class{constructor(e,t,i,r){this.isSub=!1;this.__loadedMap=new Map,this.isSub=r,this.modules=e,this.__progress=t,this.__callback=i}load(){this.__loadedMap.clear();let e=!1;for(let t=0;t<this.modules.length;t++){let i=this.modules[t];R.single.getModule(i)?this.__loadedMap.set(i,1):(e=!0,ve.single.load(i,this.isSub))}e||this.__checkComplete()}childComplete(e){this.__loadedMap.set(e,1),this.__checkComplete()}childError(e,t){this.__callback&&this.__callback(t)}childProgress(e,t){this.__loadedMap.set(e,t);let i=this.loaded/this.modules.length;this.__progress&&this.__progress(i)}__checkComplete(){let e=this.loaded/this.modules.length;this.__progress&&this.__progress(e),e==1&&this.__callback!=null&&(this.__callback(null),this.destroy())}get loaded(){let e=0;for(let t of this.__loadedMap.values())e+=t;return e}destroy(){this.modules=null,this.__progress=null,this.__callback=null}};var U=class U{constructor(){this.node=new rt("ModuleManager");this.__lastGCTime=0;this.__modules=new Map,this.__requests=new Map,this.__waitDeletes=new Set,c.addTicker(this)}tick(e){if(y.currentTime-this.__lastGCTime>U.GC_INTERVAL){for(let i of this.__waitDeletes){let r=this.getModuleProxy(i);!r||!r.module||r.module.notReleased||r.refCount<=0&&(_.log("Module Destroy:"+r.module.name,_.TYPE.Module),this.__modules.delete(i),r.destroy())}this.__waitDeletes.clear()}}load(e,t,i,r){let s=new be(e,t,i,r);this.__addRequest(s),s.load()}childComplete(e,t){this.__modules.set(e,t);let i=this.__requests.get(e);for(let r=0;r<i.length;r++)i[r].childComplete(e);i.length=0,this.__requests.delete(e)}childError(e,t){let i=this.__requests.get(e);for(let s=0;s<i.length;s++)i[s].childError(e,t);let r=i.concat();for(let s=0;s<r.length;s++){let n=r[s];this.__removeRequest(n),n.destroy()}}childProgress(e,t){let i=this.__requests.get(e);for(let r=0;r<i.length;r++)i[r].childProgress(e,t)}__addRequest(e){let t;for(let i=0;i<e.modules.length;i++){let r=e.modules[i];this.__requests.has(r)?t=this.__requests.get(r):(t=[],this.__requests.set(r,t)),t.push(e)}}__removeRequest(e){let t,i=0;for(let r=0;r<e.modules.length;r++){let s=e.modules[r];t=this.__requests.get(s),i=t.indexOf(e),i>=0&&t.splice(i,1)}}getModuleProxy(e){return this.__modules.has(e)?this.__modules.get(e):null}getModule(e){let t=this.getModuleProxy(e);return t==null?null:t.module}dispose(e){this.__modules.get(e).removeRef(),this.__waitDeletes.add(e)}static get single(){return this.__instance||(this.__instance=new U),this.__instance}};U.MAX_LOADER_THREAD=5,U.GC_INTERVAL=60;var R=U;var F=class extends st{constructor(){super();this.notReleased=!1;this.resRequest=null;this.$inited=!1;this.__moduleIndex=0;this.__eventProxy=new f(this),this.__redPoints=new Map}preInit(){this.modules&&this.modules.length>0?(this.__moduleIndex=0,R.single.load(this.modules,void 0,t=>{if(t)throw new Error("\u6A21\u5757\u521D\u59CB\u5316\u5931\u8D25:"+t.message);for(let r=0;r<this.modules.length;r++){let s=this.modules[r],n=this.$getModule(s);R.single.getModuleProxy(s).addRef(),n.$inited?this.__moduleIndex++:n.on(a.COMPLETE,this.__otherModuleInitComplete,this)}let i=this.modules?this.modules.length:0;this.__moduleIndex>i&&this.init(),this.on(a.COMPLETE,this.__otherModuleInitComplete,this),this.selfInit()},!0)):(this.on(a.COMPLETE,this.__otherModuleInitComplete,this),this.selfInit())}__otherModuleInitComplete(t){t.target.off(a.COMPLETE,this.__otherModuleInitComplete,this),this.__moduleIndex++;let r=this.modules?this.modules.length:0;this.__moduleIndex>r&&this.init()}selfInit(){this.selfInitComplete()}selfInitComplete(){this.$inited=!0,this.emit(a.COMPLETE)}init(){}getConfigAccessor(t){return x.getAccessor(t)}$getModule(t){if(!this.modules||this.modules.indexOf(t)<0)throw new Error("\u6A21\u5757\u4E0D\u5B58\u5728:"+t);return R.single.getModule(t)}registerRedPoint(t,i){this.__redPoints.set(t,i),N.single.register(t,i)}destroy(){if(this.configs=null,this.modules&&this.modules.length>0){for(let t=0;t<this.modules.length;t++){let i=this.modules[t];R.single.dispose(i)}this.modules=null}this.notReleased=!1,this.assets=null,this.resRequest&&(this.resRequest.dispose(),this.resRequest=null);for(let[t,i]of this.__redPoints)N.single.unregister(t);return this.__redPoints.clear(),this.__redPoints=null,this.$inited=!1,this.__moduleIndex=0,super.destroy()}get inited(){return this.$inited}on(t,i,r,s){this.__eventProxy.on(t,i,r,s)}off(t,i,r){this.__eventProxy.off(t,i,r)}offByCaller(t){this.__eventProxy.offByCaller(t)}offAllEvent(){this.__eventProxy.offAllEvent()}emit(t,i){this.__eventProxy.emit(t,i)}hasEvent(t){return this.__eventProxy.hasEvent(t)}hasEventHandler(t,i,r){return this.__eventProxy.hasEventHandler(t,i,r)}};var Pe=class{static get(e,t,i,r){this.http(e,"get",t,i,r)}static post(e,t,i,r){this.http(e,"post",t,i,r)}static http(e,t,i,r,s){if(i){let o="?";for(let l in i){let h=this.isValidKey(l,i);e+=`${o}${l}=${h}`,o="&"}}_.log(`http send:${e}`,_.TYPE.NET);let n=new XMLHttpRequest;t=="get"?n.open("get",e,!0):n.open("post",e),s!=null?s(n):this.setRequestHeader(n),n.onreadystatechange=()=>{if(console.log("url : "+n.responseURL),n.readyState==4){let o=n.status,l=n.responseText;o>=200&&o<300?(_.log(`url:(${e}) result:${l})`,_.TYPE.NET),r(void 0,l)):(_.log(`url:(${e}) request error. status:(${n.status})`,_.TYPE.NET),r(new Error(`Http:${t}\u5931\u8D25:${e}`)))}},n.send()}static isValidKey(e,t){return e in t}static setRequestHeader(e){e.setRequestHeader("Content-Type","text/plain;charset=UTF-8;application/x-www-form-urlencoded;application/json;charset=UTF-8"),e.setRequestHeader("Cache-Control","no-store")}};var Q=class{constructor(){this.__socketMap=new Map}initSocket(e,t){if(this.__socketMap.has(t))throw new Error(`socket ${t} is exist`);if(e==null)throw new Error("protocal is null");let i=new Z(e);return i.name=t,this.__socketMap.set(t,i),i}hasSocket(e){return this.__socketMap.has(e)}getSocket(e){if(!this.__socketMap.has(e))throw new Error(`socket ${e} is not exist`);return this.__socketMap.get(e)}};var je=(i=>(i.SOCKET_CONNECTED="SOCKET_CONNECTED",i.SOCKET_ERROR="SOCKET_ERROR",i.SOCKET_CLOSE="SOCKET_CLOSE",i))(je||{}),C=class{static setDefaultSocket(e){this.__default_socket=e}static hasSocket(e){return this.impl.hasSocket(e)}static initSocket(e,t){if(t==null&&(t=this.__default_socket),t==null)throw new Error("\u8BF7\u5148\u8BBE\u7F6E\u9ED8\u8BA4socket\u7C7B\u578B");return this.impl.initSocket(e,t)}static getSocket(e){if(e==null&&(e=this.__default_socket),e==null)throw new Error("\u8BF7\u5148\u8BBE\u7F6E\u9ED8\u8BA4socket\u7C7B\u578B");return this.impl.getSocket(e)}static get impl(){return this.__impl==null&&(this.__impl=g.getInject(this.KEY)),this.__impl==null&&(this.__impl=new Q),this.__impl}};C.KEY="SocketManager",C.EventType=je,C.__default_socket="GameSocket";var Re=class Re extends f{constructor(t){super();this.error_count=0;this.is_conected=!1;if(t==null)throw new Error("message_parser is null");this.cache_msgs=new Map,this.message_protocol=t,this.message_protocol.parse_callback=this.onMessageParseCallback.bind(this)}getCacheMsg(t){if(!this.cache_msgs.has(t))return null;let i=this.cache_msgs.get(t);return this.cache_msgs.delete(t),i}isConected(){return this.is_conected}connect(t,i="arraybuffer"){this.web_socket=new WebSocket(t),this.web_socket.binaryType=i,this.web_socket.onclose=this.onclose.bind(this),this.web_socket.onerror=this.onerror.bind(this),this.web_socket.onopen=this.onopen.bind(this),this.web_socket.onmessage=this.onmessage.bind(this),this.error_count=0}reconnect(){let t=this.web_socket.readyState;t==WebSocket.CONNECTING||t==WebSocket.OPEN||(this.web_socket&&(this.web_socket.close(),this.web_socket.onclose=null,this.web_socket.onerror=null,this.web_socket.onopen=null,this.web_socket.onmessage=null),this.web_socket=new WebSocket(this.web_socket.url),this.web_socket.onclose=this.onclose.bind(this),this.web_socket.onerror=this.onerror.bind(this),this.web_socket.onopen=this.onopen.bind(this),this.web_socket.onmessage=this.onmessage.bind(this))}close(){this.web_socket.close(),this.is_conected=!1}onopen(t){this.is_conected=!0,this.emit(C.EventType.SOCKET_CONNECTED)}send(t,i){_.log("["+this.name+"][C2S]"+t+"  =>"+JSON.stringify(i),_.TYPE.NET),this.web_socket.send(this.message_protocol.encode(t,i))}onmessage(t){this.message_protocol.decode(t.data)}onMessageParseCallback(t,i){_.log("["+this.name+"][S2C]"+t+"    <="+JSON.stringify(i),_.TYPE.NET),this.hasEvent(t)?this.emit(t,i):(console.log(this.name+" \u68C0\u6D4B\u5230\u672A\u5904\u7406\u6D88\u606F:"+t+",\u5185\u90E8\u5C06\u7F13\u5B58\u8BE5\u6D88\u606F"),this.cache_msgs.set(t,i))}onclose(t){this.emit(C.EventType.SOCKET_CLOSE)}onerror(t){this.is_conected=!1,this.error_count++,this.error_count<Re.MAX_ERROR_COUNT?this.reconnect():this.emit(C.EventType.SOCKET_ERROR,null,new Error(this.name+" socket \u94FE\u63A5\u9519\u8BEF!"))}};Re.MAX_ERROR_COUNT=3;var Z=Re;var S=class extends f{start(e){}addEventHandler(e,t){this.on(a.PROGRESS,e,t),this.on(a.COMPLETE,e,t),this.on(a.ERROR,e,t)}removeEventHandler(e,t){this.off(a.PROGRESS,e,t),this.off(a.COMPLETE,e,t),this.off(a.ERROR,e,t)}destroy(){return this.offAllEvent(),super.destroy()}};var De=class extends S{constructor(){super();this.__index=0;this.__taskList=[]}addTask(t){if(Array.isArray(t))for(let i=0;i<t.length;i++){let r=t[i];this.__addTask(r)}else this.__addTask(t)}__addTask(t){if(this.__taskList.indexOf(t)>=0)throw new Error("\u91CD\u590D\u6DFB\u52A0\uFF01");this.__taskList.push(t)}removeTask(t){let i=this.__taskList.indexOf(t);if(i<0)throw new Error("\u672A\u627E\u5230\u8981\u5220\u9664\u7684\u5185\u5BB9\uFF01");this.__taskList.splice(i,1)}start(t){this.__data=t,this.__index=0,this.__tryNext()}__tryNext(){if(this.__index<this.__taskList.length){let t=this.__taskList[this.__index];t.on(a.COMPLETE,this.__subTaskEventHandler,this),t.on(a.PROGRESS,this.__subTaskEventHandler,this),t.on(a.ERROR,this.__subTaskEventHandler,this),t.start(this.__data)}else this.emit(a.COMPLETE)}__subTaskEventHandler(t){if(t.type==a.PROGRESS){let i=(this.__index+t.progress)/this.__taskList.length;this.emit(a.PROGRESS,i);return}if(t.target.offAllEvent(),t.type==a.ERROR){this.emit(a.ERROR,t.error);return}t.target.destroy(),this.__index++,this.__tryNext()}destroy(){return this.__taskList.length=0,this.__index=0,super.destroy()}};var Oe=class extends S{constructor(){super();this.__taskList=new Array;this.__index=0}addTask(t){if(this.__taskList.indexOf(t)>=0)throw new Error("\u91CD\u590D\u6DFB\u52A0\uFF01");this.__taskList.push(t)}removeTask(t){let i=this.__taskList.indexOf(t);if(i<0)throw new Error("\u627E\u4E0D\u5230\u8981\u5220\u9664\u7684\u5185\u5BB9!");this.__taskList.splice(i,1)}start(t){for(let i=0;i<this.__taskList.length;i++){let r=this.__taskList[i];r.on(a.COMPLETE,this.__subTaskEventHandler,this),r.on(a.ERROR,this.__subTaskEventHandler,this),r.on(a.PROGRESS,this.__subTaskEventHandler,this),r.start(t)}}__subTaskEventHandler(t){if(t.type==a.PROGRESS){this.emit(a.PROGRESS,this.__index/this.__taskList.length);return}if(t.target.offAllEvent(),t.type==a.ERROR){this.emit(a.ERROR,t.error);return}this.__index++,!(this.__index<this.__taskList.length)&&(t.target.destroy(),this.emit(a.COMPLETE))}destroy(){return this.__taskList.length=0,this.__index=0,super.destroy()}};var V=class{constructor(){this.__flags=0;this.__elements=[]}reset(){this.__flags=0}add(e){this.__flags|=e,this.__elements.indexOf(e)<0&&this.__elements.push(e)}remove(e){this.__flags^=e;let t=this.__elements.indexOf(e);t>=0&&this.__elements.splice(t,1)}has(e){return(this.__flags&e)==e}get flags(){return this.__flags}get elements(){return this.__elements}destroy(){this.__flags=0,this.__elements.length=0,this.__elements=null}static getBit(e){if(this.TYPES.has(e))return this.TYPES.get(e);this.TYPE_IDX++;let t=Math.pow(2,this.TYPE_IDX);return this.TYPES.set(e,t),this.BITS.set(t,e),t}static getType(e){return this.BITS.get(e)}};V.TYPES=new Map,V.BITS=new Map,V.TYPE_IDX=0;var Se=class{constructor(){}reset(){this.method=null,this.caller=null}destroy(){return this.reset(),!0}run(...e){let t=null;if(this.method)t=this.method.apply(this.caller,e);else throw new Error("Handler method is null!");return t}equal(e){return this.method==e.method&&this.caller==e.caller}equals(e,t){return this.method==e&&this.caller==t}};var Ee=class{constructor(e){this.key=e.join("_"),this.keys=e,this.map=new Map}save(e,t){if(this.keys.length==1){let i=this.keys[0],r=e[i];if(this.map.has(r))throw new Error(`\u914D\u7F6E\u8868${t}\u552F\u4E00Key\u5B58\u5728\u91CD\u590D\u5185\u5BB9:${r}`);this.map.set(r,e)}else{let i=[];for(let s=0;s<this.keys.length;s++){let n=this.keys[s];i.push(e[n])}let r=i.join("_");if(!r||r.length==0)return;if(this.map.has(r))throw new Error(`\u914D\u7F6E\u8868${t}\u552F\u4E00Key\u5B58\u5728\u91CD\u590D\u5185\u5BB9:${r}`);this.map.set(r,e)}}get(e){if(this.map.has(e))return this.map.get(e)}destroy(){this.key=void 0,this.keys=null,this.map.clear(),this.map=null}};var xe=class{constructor(){this.$configs=[];this.$storages=new Map}addStorage(e){let t=e.join("_");if(this.$storages.has(t))throw new Error("\u91CD\u590D\u6DFB\u52A0\u914D\u7F6E\u8868\u5B58\u50A8\u65B9\u5F0F\uFF1A"+t);this.$storages.set(t,new Ee(e))}save(e){if(this.$configs.indexOf(e)>=0)return!1;this.$configs.push(e);for(let i of this.$storages.values())i.save(e,this.sheetName);return!0}getOne(e,t){return this.get([e],[t])}get(e,t){if(!(!e||!t||e.length==0||t.length==0)){if(e.length!=t.length)throw new Error("\u53C2\u6570\u957F\u5EA6\u4E0D\u4E00\u81F4!");if(e.length==1){let i=e[0],r=t[0];if(this.$storages.has(i))return this.$storages.get(i).get(r)}else{let i=e.join("_");if(this.$storages.has(i)){let r=this.$storages.get(i),s=t.join("_");return r.get(s)}}}}getStorage(e){return this.$storages.get(e.join("_"))}getElements(){return this.$configs}destroy(){this.$configs=null;for(let e of this.$storages.values())e.destroy();this.$storages.clear(),this.$storages=null}};var ee=class{static isEmpty(e){return!e||e.length===0}static str2NumArrList(e,t=["|",","]){if(t.length<2)throw new Error("separators \u957F\u5EA6\u4E0D\u80FD\u5C0F\u4E8E2");if(!e)return[];let i=e.split(t[0]),r=i.length,s=[];for(let n=0;n<r;n++){let o=i[n].split(t[1]).map(l=>Number(l));s.push(o)}return s}static str2StringList(e,t=["|",","]){let i=e.split(t[0]),r=i.length,s=[];for(let n=0;n<r;n++){let o=i[n].split(t[1]);s.push(o)}return s}static substitute(e,...t){if(e==null)return"";let i=t.length,r;i==1&&t[0]instanceof Array?(r=t[0],i=r.length):r=t;let s=0;return e.replace(/{}/g,(n,o)=>r[s++])}static substitute2(e,...t){if(e==null)return"";let i=t.length,r;i==1&&t[0]instanceof Array?(r=t[0],i=r.length):r=t;for(let s=0;s<i;s++)e=e.replace(new RegExp("\\{"+s+"\\}","g"),r[s]);return e}};var I=class{constructor(){}static tr(e,...t){let i,r=x.getAccessor(this.sheetName);if(r||(r=x.getAccessor(this.defaultSheetName)),r){let s=r.getOne(this.sheetItem.key,e);s==null||t==null?i=e:i=s[this.sheetItem.value]}else i=e;return t==null||t==null||t.length==0?i:ee.substitute(i,t)}static tr_res(e){return this.langenge+"/"+e}static get sheetName(){return this.fileName+"/"+this.langenge}static get defaultSheetName(){return this.fileName+"/zh_CN"}};I.fileName="t_s_language",I.langenge="zh_CN",I.sheetItem={key:"id",value:"value"};var te=class extends xe{constructor(){super(),this.addStorage([I.sheetItem.key])}};var H=class H{static equals(e,t){return Math.abs(e-t)<=H.ZeroTolerance}static int(e){return parseInt(e.toString(),10)}static getIntersectionPoint(e,t,i,r,s){s=s||{x:0,y:0};var n=(e.x-i.x)*(t.y-i.y)-(e.y-i.y)*(t.x-i.x),o=(e.x-r.x)*(t.y-r.y)-(e.y-r.y)*(t.x-r.x);if(n*o>=0)return null;var l=(i.x-e.x)*(r.y-e.y)-(i.y-e.y)*(r.x-e.x),h=l+n-o;if(l*h>=0)return null;var m=l/(o-n),p=m*(t.x-e.x),A=m*(t.y-e.y);return s.x=e.x+p,s.y=e.y+A,s}static getPerpendicularPoint(e,t,i,r,s,n,o){o=o||{x:0,y:0};let l=s-i,h=n-r,m=(s-i)*(e-i)+(n-r)*(t-r);return m/=l*l+h*h,m>=0&&m<=1?(o.x=i+m*l,o.y=r+m*h,o):null}static getNearestDistance(e,t,i){let r={x:0,y:0},s={x:0,y:0},n={x:0,y:0};r.x=e.x,r.y=e.y,s.x=t.x,s.y=t.y,n.x=i.x,n.y=i.y;var o,l,h;if(o=this.distance(n.x,n.y,r.x,r.y),o<=1e-5||(l=this.distance(s.x,s.y,r.x,r.y),l<=1e-5))return 0;if(h=this.distance(s.x,s.y,n.x,n.y),h<=1e-5)return o;if(o*o>=l*l+h*h)return l;if(l*l>=o*o+h*h)return o;var m=(o+l+h)/2,p=Math.sqrt(m*(m-o)*(m-l)*(m-h));return 2*p/h}static vectorDot(e,t,i,r){return e*i+t*r}static vectorCross(e,t,i,r){return e*r-t*i}static calculateAngle(e,t,i,r){return Math.acos(this.vectorDot(e,t,i,r)/(Math.sqrt(e*e+t*t)*Math.sqrt(i*i+r*r)))}static distance(e,t,i,r){let s=i-e,n=r-t;return Math.sqrt(s*s+n*n)}static distanceSquared(e,t,i,r){let s=i-e,n=r-t;return s*s+n*n}static inTheCircle(e,t,i,r,s){return this.distance(e,t,i,r)<s}};H.ZeroTolerance=.001,H.Angle90=Math.PI*.5,H.Rad2Angle=180/Math.PI,H.Angle2Rad=Math.PI/180;var He=H;var qe=class{static oto(e,t){for(let i in e)t[i]=e[i]}static deepClone(e){if(!e||typeof e!="object")return null;var t=JSON.stringify(e);return JSON.parse(t)}static clear(e){for(let t in e)delete e[t]}};import{assetManager as nt}from"cc";var Te=class Te extends f{constructor(){super()}load(e){if(this.url=e,typeof e=="string")throw new Error("\u672A\u5B9E\u73B0\uFF01");let t=this,i=e.url;Te.force&&(i+="?v="+Date.now()),nt.loadRemote(i,(r,s)=>{if(r){t.emit(a.ERROR,e,r);return}let n=d.url2Key(e),o=new k;o.key=n,o.content=s;let l=this.__parseConfig(e,s);o.content=l,v.addRes(o),t.emit(a.COMPLETE,e)})}__parseConfig(e,t){let i=t.json;if(d.url2Sheet==null)throw new Error("Res.url2Sheet\u672A\u5B9A\u4E49!\u8BF7\u5728\u521D\u59CB\u5316\u524D\u8BBE\u7F6E!");let r=d.url2Sheet(e),s=x.getAccessorClass(r),n=new s;n.sheetName=r;for(let o=0;o<i.length;o++){let l=i[o];n.save(l)}return n}reset(){this.url=void 0,this.offAllEvent()}};Te.force=!0;var Me=Te;var ie=class{static setup(e,t,i){d.setLoader(d.TYPE.CONFIG,Me),I.langenge!="zh_CN"&&x.register(I.defaultSheetName,te),x.register(I.sheetName,te);let r=0,s=e.length;for(let n=0;n<e.length;n++){let o=e[n];if(this.plugins.has(o.plugin))continue;let l=new o.plugin;l.on(a.PROGRESS,h=>{t&&t((r+h.progress)/s)},this),l.on(a.ERROR,h=>{i&&i(h.error),l.offAllEvent()},this),l.on(a.COMPLETE,h=>{h.target.offAllEvent(),r++,r>=s&&(i&&i(null),this.inited=!0)},this),l.setup(...o.data),this.plugins.set(o.plugin,l)}}static getModule(e){return this.plugins.get(e)}static tick(e){this.inited&&c.tick(e)}};ie.plugins=new Map,ie.inited=!1;export{O as AudioManager,ke as Binder,V as BitFlag,$ as CCLoader,D as ClassUtils,M as Dictionary,ie as Engine,a as Event,f as EventDispatcher,J as Func,W as FuncNode,Y as FunctionHook,Se as Handler,Pe as Http,I as I18N,g as Injector,Le as List,T as LoaderManager,_ as Logger,He as MathUtils,F as Module,R as ModuleManager,qe as ObjectUtils,E as Pool,j as PropertyBinder,N as RedPoint,L as RedPointNode,d as Res,q as ResRef,B as ResRequest,k as Resource,v as ResourceManager,Z as Socket,C as SocketManager,Q as SocketManagerImpl,ee as StringUtils,S as Task,De as TaskQueue,Oe as TaskSequence,c as TickerManager,y as Timer};
//# sourceMappingURL=dream-cc-core.mjs.map
